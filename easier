# 使用ubuntu作为基础镜像
FROM ubuntu

# 更新软件源并安装所需的软件包
RUN apt-get update && apt-get install -y ubuntu-desktop novnc firefox

# 配置默认用户为root用户，并设置其密码为luo
USER root
RUN echo "root:luo" | chpasswd

# 配置默认语言为中文
ENV LANG zh_CN.UTF-8

# 设置novnc的密码为luo和端口号为8900，并暴露8900端口
RUN echo "luo" > /etc/novnc.pwd
ENV NOVNC_PORT 8900
EXPOSE 8900

# 设置ubuntu桌面为默认桌面
ENV DEBIAN_FRONTEND noninteractive
RUN echo "ubuntu-session" > /usr/share/xsessions/default.desktop

# 启动novnc服务
CMD ["/usr/bin/novnc_server"]

# 添加autoinstall参数到内核命令行
RUN sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="autoinstall"/' /etc/default/grub
RUN update-grub

# 创建一个自动安装配置文件，并通过cloud-init提供给安装程序
RUN mkdir -p /var/lib/cloud/seed/nocloud-net/
RUN echo "#cloud-config\nautoinstall:\n  version: 1\n  locale: zh_CN.UTF-8\n  keyboard:\n    layout: cn\n    variant: ''\n  network:\n    network:\n      version: 2\n      ethernets:\n        enp0s25:\n          dhcp4: yes\n  identity:\n    hostname: ubuntu\n    username: root\n    password: \$6\$exDY1mhS4KUYCE/2\$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0\n  storage:\n    layout:\n      name: lvm\n  late-commands:\n    - echo 'root ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/root\n    - curtin in-target --target=/target -- chpasswd <<< \"root:luo\"\n    - curtin in-target --target=/target -- update-grub" > /var/lib/cloud/seed/nocloud-net/user-data
RUN echo "instance-id: ubuntu-autoinstall\nlocal-hostname: ubuntu-autoinstall" > /var/lib/cloud/seed/nocloud-net/meta-data

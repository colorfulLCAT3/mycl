# 使用ubuntu作为基础镜像
FROM ubuntu

# 更新软件源并安装grub
RUN apt-get update && apt-get install -y grub-pc

# 添加preseed参数到内核命令行
RUN sed -i 's|GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT="auto=true priority=critical preseed/file=/cdrom/preseed.cfg"|' /etc/default/grub

# 创建一个preseed文件，并放在/cdrom目录下
RUN mkdir -p /cdrom
RUN echo "### Localization d-i debian-installer/locale string zh_CN.UTF-8 d-i console-setup/ask_detect boolean false d-i keyboard-configuration/layout select Chinese d-i keyboard-configuration/variant select Chinese ### Network configuration d-i netcfg/choose_interface select auto ### Mirror settings d-i mirror/country string manual d-i mirror/http/hostname string archive.ubuntu.com d-i mirror/http/directory string /ubuntu d-i mirror/http/proxy string ### Account setup d-i passwd/root-login boolean true d-i passwd/root-password password luo d-i passwd/root-password-again password luo ### Clock and time zone setup d-i clock-setup/utc boolean true # Set the time zone to Asia/Shanghai. You can use the command # `tzsetup` to see the full list of available time zones. d-i time/zone string Asia/Shanghai ### Partitioning d-i partman-auto/method string lvm d-i partman-lvm/device_remove_lvm boolean true d-i partman-lvm/device_remove_lvm_span boolean true d-i partman-lvm/confirm boolean true d-i partman-lvm/confirm_nooverwrite boolean true d-i partman-auto-lvm/guided_size string max d-i partman-auto/choose_recipe select atomic ### Base system installation tasksel tasksel/first multiselect ubuntu-desktop ### Boot loader installation d-i grub-installer/only_debian boolean true ### Finishing up the installation d-i finish-install/reboot_in_progress note
" > /cdrom/preseed.cfg

# 安装其他所需的软件包
RUN apt-get install -y novnc firefox

# 配置默认用户为root用户，并设置其密码为luo
USER root
RUN echo "root:luo" | chpasswd

# 配置默认语言为中文
ENV LANG zh_CN.UTF-8

# 设置novnc的密码为luo和端口号为8900，并暴露8900端口
RUN echo "luo" > /etc/novnc.pwd
ENV NOVNC_PORT 8900
EXPOSE 8900

# 设置ubuntu桌面为默认桌面
ENV DEBIAN_FRONTEND noninteractive
RUN echo "ubuntu-session" > /usr/share/xsessions/default.desktop

# 启动novnc服务
CMD ["/usr/bin/novnc_server"]

# 更新grub引导加载器并指定root设备为overlay
RUN update-grub --boot-directory=/boot --root-directory=overlay
